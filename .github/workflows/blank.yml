name: Run code-server with Pinggy Tunnel

on: workflow_dispatch

jobs:
  code-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install code-server
        run: curl -fsSL https://code-server.dev/install.sh | sh -x

      - name: Install sshpass
        run: sudo apt update && sudo apt install sshpass -y

      - name: Start code-server
        run: |
          export PASSWORD=${{ secrets.CODESERVER_PASSWORD }}
          code-server --bind-addr 0.0.0.0:8080 --auth password &
          sleep 5  # Wait for code-server to start

      - name: Start Pinggy tunnel
        run: |
          sshpass -p "" ssh -p 443 -R0:localhost:8080 -o StrictHostKeyChecking=no qr@free.pinggy.io > pinggy.log 2>&1 &
          sleep 10  # Wait for tunnel to initialize
          PUBLIC_URL=$(grep -o 'https://[^ ]*\.a\.free\.pinggy\.link' pinggy.log | head -1)
          echo "code-server is available at: $PUBLIC_URL"
          echo "Password: ${{ secrets.CODESERVER_PASSWORD }}"

      - name: Keep job running
        run: sleep 36000000  # Keep the job alive for 1 hour (adjust as needed)
