name: Run code-server with Cloudflared Tunnel

on: workflow_dispatch

jobs:
  code-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install code-server
        run: curl -fsSL https://code-server.dev/install.sh | sh -x

      - name: Install cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
          chmod +x /usr/local/bin/cloudflared

      - name: Start code-server
        run: |
          export PASSWORD=${{ secrets.CODESERVER_PASSWORD }}
          code-server --bind-addr 0.0.0.0:8080 --auth password &
          sleep 5  # Wait for code-server to start

      - name: Start cloudflared tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 > cloudflared.log &
          sleep 10  # Wait for tunnel to initialize
          PUBLIC_URL=$(grep -o 'https://.*\.trycloudflare.com' cloudflared.log)
          echo "code-server is available at: $PUBLIC_URL"
          echo "Password: ${{ secrets.CODESERVER_PASSWORD }}"

      - name: Keep job running
        run: sleep 3600  # Keep the job alive for 1 hour (adjust as needed)
