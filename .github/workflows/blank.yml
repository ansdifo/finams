name: Web VS Code via Cloudflare

on:
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼

jobs:
  vscode:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6æ™‚é–“ (é–‹ç™ºæ™‚é–“ç¢ºä¿)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install code-server (latest)
        run: curl -fsSL https://code-server.dev/install.sh | sh

      - name: Generate password
        run: |
          PASS=$(openssl rand -base64 16)
          echo "PASSWORD=$PASS" >> $GITHUB_ENV
          echo "Generated password: $PASS"

      - name: Start code-server
        run: |
          export PASSWORD="${{ env.PASSWORD }}"
          code-server --bind-addr 0.0.0.0:8080 --auth password \
            --user-data-dir /tmp/code-server-data \
            --extensions-dir /tmp/code-server-extensions &
          # èµ·å‹•å¾…æ©Ÿã¨ç¢ºèª
          sleep 10
          if curl -f http://localhost:8080; then
            echo "code-server started successfully"
          else
            echo "code-server startup failed"
            exit 1
          fi
        env:
          PASSWORD: ${{ env.PASSWORD }}

      - name: Setup cloudflared
        uses: AnimMouse/setup-cloudflared@v2  # 2025å¹´æœ€æ–°: cloudflared v2025.10.1 ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      - name: Create Cloudflare Quick Tunnel & Show URL
        run: |
          # Quick Tunnel èµ·å‹• (localhost:8080 ã‚’å…¬é–‹ã€ä¸€æ™‚ URL ç”Ÿæˆ)
          nohup cloudflared tunnel --url http://localhost:8080 &
          CLOUDFLARED_PID=$!
          sleep 10  # ãƒˆãƒ³ãƒãƒ«èµ·å‹•å¾…æ©Ÿ
          
          # URL å–å¾— (ãƒ­ã‚°ã‹ã‚‰æœ€åˆã® https://*.trycloudflare.com ã‚’æŠ½å‡º)
          TUNNEL_URL=$(cloudflared tunnel info 2>&1 | grep -o 'https://[-a-z0-9]*\.trycloudflare\.com' | head -1)
          if [ -z "$TUNNEL_URL" ]; then
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ã‚°ã‹ã‚‰æŠ½å‡º
            TUNNEL_URL=$(journalctl -u cloudflared --no-pager 2>/dev/null | grep -o 'https://[-a-z0-9]*\.trycloudflare\.com' | head -1) || echo "Tunnel URL extraction failed"
          fi
          
          echo ""
          echo "=== Web VS Code is READY via Cloudflare Tunnel! ==="
          echo "**Public URL:** $TUNNEL_URL"
          echo "**Password:** ${{ env.PASSWORD }}"
          echo "================================="
          echo "::notice title=ğŸš€ Web VS Code Ready!::Open **$TUNNEL_URL** (Password: ${{ env.PASSWORD }})"
          
          # ãƒ—ãƒ­ã‚»ã‚¹ä¿æŒ (å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§å¾…æ©Ÿ)
          echo "CLOUDFLARED_PID=$CLOUDFLARED_PID" >> $GITHUB_ENV

      - name: Keep session alive (2 hours, adjust as needed)
        if: success()
        run: |
          # 2æ™‚é–“å¾…æ©Ÿ (Cloudflare ãƒˆãƒ³ãƒãƒ«ç¶­æŒ)
          sleep 7200
          # çµ‚äº†æ™‚ã«ãƒˆãƒ³ãƒãƒ«åœæ­¢ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
          kill ${{ env.CLOUDFLARED_PID }} || true

      - name: Shutdown cloudflared logs
        if: always()
        uses: AnimMouse/setup-cloudflared/shutdown@v2  # ãƒ­ã‚°å‡ºåŠ›ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
