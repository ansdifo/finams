name: Web VS Code Environment

on:
  workflow_dispatch:  # 手動トリガーで実行 (GitHub UI から)

jobs:
  start-vscode:
    runs-on: ubuntu-latest  # 最新の Ubuntu runner を使用 (2025 年時点で Node.js 20+ プリインストール)

    permissions:
      contents: read  # リポジトリチェックアウト用

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # 最新バージョンでリポジトリをチェックアウト (開発対象のコードをロード)

      - name: Setup Node.js
        uses: actions/setup-node@v4  # Node.js をセットアップ (code-server の依存)
        with:
          node-version: '20'  # code-server v4.22+ の推奨 (2025 年最新)

      - name: Install code-server
        run: |
          # code-server の最新リリースをダウンロード・インストール (公式ドキュメントに基づく)
          curl -fsSL https://code-server.dev/install.sh | sh
          sudo systemctl enable --now code-server@$USER  # ユーザーサービスとして有効化

      - name: Generate random password
        run: |
          # ランダムパスワード生成 (ログ出力用)
          PASSWORD=$(openssl rand -base64 16)
          echo "CODE_SERVER_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          echo "Generated password: $PASSWORD"  # ログに表示 (本番では secrets を使用推奨)

      - name: Start code-server
        run: |
          # code-server をバックグラウンドで起動 (ポート 8080、認証有効)
          export PASSWORD="${{ env.CODE_SERVER_PASSWORD }}"
          code-server --bind-addr 0.0.0.0:8080 --auth password \
            --user-data-dir /tmp/code-server-data \
            --extensions-dir /tmp/code-server-extensions &
          # 起動確認 (5秒待機)
          sleep 5
          curl -f http://localhost:8080 || echo "code-server startup failed"

      - name: Expose port and wait
        uses: actions/github-script@v7  # スクリプトでポート公開と待機
        with:
          script: |
            const http = require('http');
            const port = 8080;
            http.createServer((req, res) => {
              res.writeHead(200, { 'Content-Type': 'text/plain' });
              res.end('code-server is running! Access via browser.');
            }).listen(port);
            console.log(`Server running at http://localhost:${port}`);
            // ジョブを 30 分間待機 (開発時間確保、timeout で調整)
            await new Promise(resolve => setTimeout(resolve, 1800000));  # 30 分 = 1,800,000 ms

      - name: Upload logs if needed
        if: always()
        uses: actions/upload-artifact@v4  # ログをアーティファクトとしてアップロード (デバッグ用)
        with:
          name: vscode-logs
          path: /tmp/code-server-data/logs/*
