name: Web VS Code Environment

on:
  workflow_dispatch:  # 手動トリガーで実行

jobs:
  start-vscode:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 時間タイムアウト (開発時間確保)

    permissions:
      contents: read

    env:
      CODE_SERVER_PASSWORD: ""  # script で設定されるパスワードを env に渡す

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # code-server 互換

      - name: Install code-server
        run: |
          curl -fsSL https://code-server.dev/install.sh | sh
          # ユーザーサービス有効化 (一時 runner なので即起動用)

      - name: Generate random password
        run: |
          PASSWORD=$(openssl rand -base64 16)
          echo "CODE_SERVER_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          echo "Generated password: $PASSWORD"

      - name: Start code-server
        run: |
          export PASSWORD="${{ env.CODE_SERVER_PASSWORD }}"
          code-server --bind-addr 0.0.0.0:8080 --auth password \
            --user-data-dir /tmp/code-server-data \
            --extensions-dir /tmp/code-server-extensions &
          # 起動待機と確認
          sleep 10
          if curl -f http://localhost:8080; then
            echo "code-server started successfully"
            echo "Access URL: Add port 8080 to runner IP from logs (e.g., http://$(curl -s ifconfig.me):8080)"
          else
            echo "code-server startup failed"
            exit 1
          fi
        env:
          PASSWORD: ${{ env.CODE_SERVER_PASSWORD }}

      - name: Wait for development session
        uses: actions/github-script@v8  # v8 に更新 (Node 24 対応)
        env:
          WAIT_MS: 1800000  # 30 分 = 1,800,000 ms (調整可能)
          PASSWORD: ${{ env.CODE_SERVER_PASSWORD }}  # env 経由で渡す
        with:
          script: |
            // 30 分待機 (開発セッション確保)
            // process.env で環境変数アクセス (v8 推奨)
            const waitMs = parseInt(process.env.WAIT_MS, 10);
            const password = process.env.PASSWORD;
            console.log(`Waiting ${waitMs / 60000} minutes for development. Password: ${password}`);
            console.log('code-server is running on port 8080. Check runner logs for public IP.');
            
            // Promise で待機 (async 関数本体として正しく記述)
            await new Promise(resolve => setTimeout(resolve, waitMs));
            
            console.log('Development session timeout reached.');

      - name: Upload logs if needed
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vscode-logs
          path: /tmp/code-server-data/logs/**
