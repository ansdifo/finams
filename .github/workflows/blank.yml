name: Run code-server with localtunnel

on: workflow_dispatch

jobs:
  code-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install localtunnel
        run: npm install -g localtunnel

      - name: Install code-server
        run: curl -fsSL https://code-server.dev/install.sh | sh -x

      - name: Start code-server
        run: |
          export PASSWORD=${{ secrets.CODESERVER_PASSWORD }}
          code-server --bind-addr 0.0.0.0:8080 --auth password &
          sleep 5  # Wait for code-server to start

      - name: Start localtunnel
        run: |
          lt --port 8080 > localtunnel.log &
          sleep 10  # Wait for localtunnel to initialize
          PUBLIC_URL=$(grep -o 'https://.*\.lvh.me' localtunnel.log || grep -o 'https://.*\.localtunnels.me' localtunnel.log)
          echo "code-server is available at: $PUBLIC_URL"
          echo "Password: ${{ secrets.CODESERVER_PASSWORD }}"

      - name: Keep job running
        run: sleep 3600  # Keep the job alive for 1 hour (adjust as needed)
